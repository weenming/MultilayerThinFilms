# Needle Optimization Using TFNN
## Overview
TFNN is an efficient algorithm in computing transmission matrices when simulating optical response of multi-layer structures.
We implement TFNN in needle optimization, which is a classical algorithm in designing layers with little known information of the target.

The aim of this project is 
- increase the efficiency of traditional algorithms
- search for the underlining rules determining the design results.
- find ways to realize better designs of multi-layer films.
  - lower total optical thickness
  - lower layer numbers
  - fewer "super thin" layers which is impractical in realistic manufacture.
## File structure

- `script`
  - `TFNN` implements training of TFNN  
    - `get_insert_jacobi.py` Calculate insertion Jacobi matrix for gradient in needle method using TFNN
    - `get_jacobi.py` Calculate Jacobi matrix in gradient descent using TFNN
    - `get_n.py` Calculate and set refractive indices in Film instances
    - `get_spectrum.py` Calculate spectrum from a film instance
  - `design.py`
  - `film.py`
  - `LM_gradient_descent.py`
  - `needle_insert.py`

`main` files implements
- LM descent
- needle insertion iterations
- multi-thread acceleration.

`gets` module contains functions returning
- reflectance/transmittance spectrums
- gradient (Jacobi matrices) for optimizing layer thickness
- gradient for insertions in needle method.

## To-do

- film class
  - instance has: refractive index of each layer at specified wl
- conceal LM and insertions into modules, making main functions more concise and reduce duplicate code.
- unit tests


### CUDA

Use functions from `cmath` or `math` in kernel or device functions. `cmath` supports complex number while `math` enables CUDA fastmath acceleration
Unsupported numpy functions:
  - array methods.
  - functions that returns a new array.
In other words, basically only scaler functions are implemented in Numba. [ref](https://numba.discourse.group/t/usage-of-cuda-python-linear-algebra-on-gpu-and-computational-code/1064) 
[document](https://numba.readthedocs.io/en/stable/cuda/cudapysupported.html#numpy-support)

After calculation of backward rpopagation and acquiring of Jacobi matrix, it seems that Cupy can also be used.

Seems that not mannualy copying ary from host to device introduce more error